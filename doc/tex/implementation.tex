\chapter{Технологический раздел}
\label{cha:implementation}

\section{Формат описания модели объектно-ориентированной программы}

Основой является формат YAML~\cite{YAML}.
Формат был выбран благодаря следующим достоинствам:
\begin{itemize}
\item текстовое представление;
\item поддержка рекурсивных структур и ссылок;
\item поддержка пользовательских типов данных.
\end{itemize}

Корневой элемент модели помечается тегом \verb;!Model; и является списком элементов
модели:
\begin{minted}{yaml}
!Model:
- <Classifier>
\end{minted}

\verb;Classifier; -- любой из элементов, помеченный тегом \verb;!Class;,
\verb;!Classifier;, \verb;!DataType;, \verb;!Enumeration;, \verb;!Interface;,
\verb;!PrimitiveType;, который имеет структуру:
\begin{minted}{yaml}
!Classifier
name: <str>
properties:
  - <Property>
operations:
  - <Operation>
generals:
  - <Classifier>
suppliers:
  - <Classifier>
\end{minted}

Каждый из атрибутов является опциональным.
Если не задано имя (\verb;name;), то элементу будет задано уникальное
имя вида \verb;anonymous_<число>;.
Выполняется для такого же атрибута других типов элементов.

\verb;Property; --- элемент, помеченный тегом \verb;!Property; со следующей
структурой:
\begin{minted}{yaml}
!Property
name: <str>
type: <Type>
visibility: <Visibility>
aggregation: <Aggregation>
is_static: <bool>
owner: <Classifier>
\end{minted}

\verb;Operation; --- элемент, помеченный тегом \verb;!Operation; со следующей
структурой:
\begin{minted}{yaml}
!Operation
name: <str>
result: <Type>
visibility: <Visibility>
parameters:
  - <Parameter>
is_static: <bool>
invocations:
  - <Operation>
owner: <Classifier>
\end{minted}

\verb;Type; --- элемент, помеченный тегом \verb;!Type; со следующей
структурой:
\begin{minted}{yaml}
!Operation
classifier: <Classifier>
lower: <int>
upper: <int>
is_ordered: <bool>
is_unique: <bool>
\end{minted}

\verb;Visibility; --- элемент, помеченный тегом \verb;!Visibility;,
имеющий одно из допустимых значений:
\begin{itemize}
\item \verb;'public';
\item \verb;'protected';
\item \verb;'private';
\end{itemize}

\verb;Aggregation; --- элемент, помеченный тегом \verb;!Aggregation;,
имеющий одно из допустимых значений:
\begin{itemize}
\item \verb;'none';
\item \verb;'shared';
\item \verb;'composite';
\end{itemize}

\textbf{YAML} предоставляет возможность ссылаться на другие элементы по адресу.
Каждый элемент должен быть описан один раз.
Например, если нужно описать связь наследования между двумя классами, можно
сделать следующим образом:
\begin{minted}{yaml}
!Model
- &id001 !Class
  name: Base
- !Class
  name: Derived
  generals:
  - *id001
\end{minted}

\verb;&id001; означает, что классу с названием \verb;Base; присваивается такой
адрес. В перечислении базовых классов в классе с названием \verb;Derived;
указывается ссылка \verb;*id001; на \verb;Base;.

\section{Структура программного комлекса}

Для реализации разработанного метода разработан программный комплекс,
который позволяет выполнять поиск шаблонов проектирования в программах,
написанных на языке программирования \textbf{Java}.

В комплекс входят следующие программы:
\begin{itemize}
\item \textbf{java\_source\_model} --- программа для построения модели программы
на языке Java;
\item \textbf{java\_bytecode\_model} --- программа для построения модели программы
на основе байткода для виртуальной машины \textbf{Java};
\item \textbf{pattern\_model} --- программа для построения модели шаблона;
\item \textbf{match\_pattern} --- программа для поиска шаблонов проектирования.
\end{itemize}

Основной сценарий использования программного комплекса:
\begin{enumerate}
\item построение модели программы с помощью \textbf{java\_source\_model} или \textbf{java\_bytecode\_model};
\item построение модели шаблона из заранее заготовленных с помощью \textbf{pattern\_model};
\item запуск \textbf{match\_pattern} с результатами первых двух шагов в качестве входных данных.
\end{enumerate}

Таким образом, программу или шаблон можно описать вручную.

Программы \textbf{java\_source\_model}, \textbf{pattern\_model},
\textbf{match\_pattern} написаны на языке \textbf{Python} версии 2.7.
\textbf{java\_bytecode\_model} написана на \textbf{Java} версии 1.8.

\subsection{Программа для построения модели программы на языке Java}

Выполняет синтаксический анализ исходного кода на языке \textbf{Java} с выводом
полных имен типов.
Программа может работать с одним или множество файлов формата \textbf{.java}.
Для синтаксического анализа используется библиотека \textbf{plyj}~\cite{plyj}.
Определение полных имен внешних типов выполняется с помошью \textbf{.class} или
\textbf{.jar}-файлов.
Для их анализа используется библиотека \textbf{javatools}~\cite{javatools}.
Вывод модели в формате \textbf{.yaml} выполняется с помощью библиотеки
\textbf{PyYAML}~\cite{PyYAML}.

Интерфейс запуска:
\begin{verbatim}
python java_source_model.py [-h] [-p <external_path>] <path> [<path> ...]
\end{verbatim}

\begin{itemize}
\item \verb;path; --- путь к .java файлу или директории;
\item \verb;-h; или \verb;--help; --- выводит сообщение с описанием параметров
запуска;
\item \verb;-p <external_path>; или \verb;--path <external_path>; --- задает
путь \verb;external_path; к \textbf{.class}, \textbf{.jar} файлам или директории;
\end{itemize}

Выводит модель в формате \textbf{.yaml} в \textbf{stdout}.
Сообщения об ошибках выводятся в \textbf{stderr}.

Алгоритм работы программы:
\begin{enumerate}
\item рекурсивно найти все \textbf{.java}-файлы по всем заданным путям;
\item выполнить синтаксический анализ всех \textbf{.java}-файлов и построить
деревья вывода;
\item во всех деревьях вывода установить полные имена классов в их определении.
\item создать пустые элементы модели: классы, интерфейсы и перечисления;
\item создать пустые элементы модели для внешних зависимостей;
\item во всех деревьях вывода установить полные имена типов в любых местах их
использования;
\item определить связи обобщения;
\item заполнить элементы модели свойствами, операциями и создать типы данных;
\item определить связи зависимости;
\item вывести модель в формате \textbf{.yaml}.
\end{enumerate}

При анализе программ с множеством пакетов и вложенных классов может возникнуть
ситуация конфликта имен.
Допустим \verb;class A; есть в \verb;package x; и в \verb;package y;.
Это два разных класса.
В исходном коде и дереве вывода скорее всего будет представлено короткое название
для каждого класса.
При построении модели недопустимо использовать эти короткие названия.
Нужно вывести полное названия типа.
Таким образом, в модель попадут классы \verb;x.A; и \verb;y.A;.
В этом случае конфликта имен не будет.

Проблема имеет место не только в определениях типов, но и в их использовании.
Например, есть \verb;class x.A;, \verb;class y.A; и в \verb;class z.B; определен
метод \verb;A f();.
Нужно определить полное имя возвращаемого типа.
Сюда же можно отнести определение типа поля класса, локальной переменной,
параметра метода, базового класса.
В данном случае нужно учитывать, импорт какого пакета был выполнен.
Аналогичная ситуация с вложенными классами.

Другая проблема, которая не решалась в этой программе, заключается в определении
зависимостей между вызываемым и вызывающим методов.

Программа не во всех случая определяет полные имена типов.
В таких случая классы, интефейсы и перечисления их представляющие игнорируются
при построении модели.
Здесь не будут описаны все ситуации, когда тип определяется, а когда нет.
Разработка программы была приостановлена.
Для дальнейшей разработки требовалось написание части компилятора \textbf{Java}.
Реальной необходимости в этом не было
поэтому взамен была написана программа на \textbf{Java},
которая содержит всю нужную функциональность.
Она описана в следующем разделе.

\subsection{Программа для построения модели программы на основе байткода для виртуальной машины Java}

Анализирует байткод виртуальной машины \textbf{Java}.
Для этого используется библиотека \textbf{Apache Commons BCEL}
(The Byte Code Engineering Library) версии 6.0~\cite{BCEL}.
Для сборки программы используется \textbf{Apache Maven} версии 3~\cite{Maven}.

Интерфейс запуска:
\begin{verbatim}
java -jar java_bytecode_model.jar <path> [<path> ...]
\end{verbatim}

\begin{itemize}
\item \verb;path; --- путь к \textbf{.class}, \textbf{.jar}-файлу или директории;
\end{itemize}

Выводит модель в формате \textbf{.yaml} в \textbf{stdout}.
Сообщения об ошибках выводятся в \textbf{stderr}.

Алгоритм работы программы:
\begin{enumerate}
\item рекурсивно и разобрать найти все \textbf{.jar} и \textbf{.class}-файлы по
всем заданным путям, \textbf{.class}-файлы в \textbf{.jar}-файлах;
\item создать пустые элементы модели для классов, интерфейсов и перечислений;
\item определить связи -- обобщения;
\item создать типы данных;
\item заполнить элементы модели свойствами и операциями;
\item определить связи -- зависимости;
\item определить связи -- вызовы методов;
\item вывести модель в формате \textbf{.yaml}.
\end{enumerate}

\subsection{Программа для построения модели шаблона}

Строит модель для одного из заготовленных шаблонов.

Интерфейс запуска:
\begin{verbatim}
python pattern_model.py [-h] <name>
\end{verbatim}

\begin{itemize}
\item \verb;name; --- название шаблона проектирования;
\item \verb;-h; или \verb;--help; --- выводит сообщение с описанием параметров
запуска.
\end{itemize}

Выводит модель в формате \textbf{.yaml} в \textbf{stdout}.
Сообщения об ошибках выводятся в \textbf{stderr}.

Реализованы следующие шаблоны:
\begin{itemize}
\item \textbf{AbstractFactory} --- абстрактная фабрика;
\item \textbf{BaseDerived} --- связка базового и производного классов;
\item \textbf{Bridge} --- мост;
\item \textbf{ChainOfResponsibility} --- цепочка ответственности;
\item \textbf{Decorator} --- декоратор;
\item \textbf{Empty} --- пустой, используется для тестирования;
\item \textbf{Memento} --- хранитель;
\item \textbf{OverriddenMethodCall} --- вызов метода базового класса,
переопределеного в производном;
\item \textbf{Visitor} --- посетитель.
\end{itemize}

\subsection{Программа для поиска шаблонов проектирования}

Выполняет поиск изоморфизмов между моделями объектно-ориетированных систем.
Для чтения модели используется библиотека \textbf{PyYAML}.

Интерфейс запуска:
\begin{verbatim}
python match_pattern.py [-h] [-l <limit>] [-a] <pattern> <target>
\end{verbatim}

\begin{itemize}
\item \verb;pattern; --- путь к \textbf{.yaml}-файлу модели шаблона;
\item \verb;target; --- путь к \textbf{.yaml}-файлу целевой модели;
\item \verb;-h; или \verb;--help; --- выводит сообщение с описанием параметров
запуска;
\item \verb;-l <limit>; или \verb;--limit <limit>; --- задает максимальное
количество изоморфизмов \verb;limit;, которое нужно найти;
\item \verb;-a; или \verb;--all_components; --- определяет, нужно ли искать
шаблон во всех компонентах связности цели, если не задан, то поиск выполняется
в наибольшей;
\end{itemize}

Выводит варианты соответствий элементов в \textbf{stdout}.
Сообщения об ошибках выводятся в \textbf{stderr}.

\subsubsection{Модуль graph\_matcher}

В этом модуле реализован алгоритм поиска изоморфного подграфа.
Структура классов представлена на рисунке~\ref{fig:graph-matcher}.

\begin{figure}[!ht]
\centering
\includegraphics[width=\textwidth]{inc/graph-matcher.pdf}
\caption{Структура классов модуля graph\_matcher}
\label{fig:graph-matcher}
\end{figure}

\textbf{Graph} --- граф.

Атрибуты:
\begin{itemize}
\item \textbf{node} --- множество вершин;
\end{itemize}

\textbf{Node} --- вершина графа.

Атрибуты:
\begin{itemize}
\item \textbf{object} --- значение вершины;
\item \textbf{connections} --- множество множеств дуг одного типа;
\item \textbf{selfConnection} --- множество типов дуг, которые соединяют вершину саму с собой;
\end{itemize}

\textbf{Connections} --- множество дуг одного типа.

Атрибуты:
\begin{itemize}
\item \textbf{label} --- метка дуг;
\item \textbf{incoming} --- множество вершин, в которые входят дуги, исходящие из текущей вершины;
\item \textbf{selfConnection} --- множество вершин, из которых исходят дуги, входящие в текущую вершины.
\end{itemize}

\textbf{Equivalent} --- пара эквивалентных вершин.

Атрибуты:
\begin{itemize}
\item \textbf{target} --- вершина целевого графа;
\item \textbf{pattern} --- вершина шаблона.
\end{itemize}

\textbf{Isomoprhic} --- пара изоморфных вершин.

Атрибуты:
\begin{itemize}
\item \textbf{target} --- вершина целевого графа;
\item \textbf{pattern} --- вершина шаблона.
\end{itemize}

\textbf{Configuration} --- конфигурация алгоритма поиска изоморфного подграфа.

Атрибуты:
\begin{itemize}
\item \textbf{selected} --- последовательность пар вершин, которые нужно проверить;
\item \textbf{checked} --- множество изоморфных вершин;
\item \textbf{current} --- индекс текущей вершины в последовательности \textbf{selected}.
\end{itemize}

Реализация алгоритма поиска изоморфных подграфов --- функция \textbf{match}:

\begin{minted}{python}
def match(target_graph, pattern_graph, match_largest_target_component=False)
\end{minted}

Параметры:
\begin{itemize}
\item \textbf{target\_graph} --- целевой граф, объект типа \textbf{Graph};
\item \textbf{pattern\_graph} --- граф шаблона, объект типа \textbf{Graph};
\item \textbf{match\_largest\_target\_component} --- \textbf{bool},
если \textbf{True}, будет выполняться поиск шаблона в наибольшей компоненте
целевого графа, иначе во всех.
\end{itemize}

Возвращает генератор списков объектов типа \textbf{Isomoprhic}.

Здесь же реализована проверка результата алгоритма --- функция \textbf{check}:

\begin{minted}{python}
def check(isomorphism)
\end{minted}

\textbf{isomorphism} --- коллекция или генератор объектов типа \textbf{Isomoprhic}.

\subsubsection{Модуль pattern\_matcher}

В этом модуле реализован алгоритм поиска шаблона проектирования в модели
объектно-ориентированной системы.
Структура связей обобщения классов представлена на рисунке~\ref{fig:pattern-matcher-generalizations}.
Структура ассоциаций классов представлена на рисунке~\ref{fig:pattern-matcher-associations}.

\begin{figure}[!ht]
\centering
\includegraphics[width=\textwidth]{inc/pattern-matcher-generalizations.pdf}
\caption{Структура классов модуля pattern\_matcher. Обобщения}
\label{fig:pattern-matcher-generalizations}
\end{figure}

\begin{figure}[!ht]
\centering
\includegraphics[width=\textwidth]{inc/pattern-matcher-associations.pdf}
\caption{Структура классов модуля pattern\_matcher. Ассоциации}
\label{fig:pattern-matcher-associations}
\end{figure}

\textbf{Element} --- базовый элемент модели.

\textbf{NamedElement} --- именованный элемент модели.

Атрибуты:
\begin{itemize}
\item \textbf{name} --- название, уникальное в зависимости от контекста.
\end{itemize}

\textbf{Aggregation} --- тип агрегации для свойства.

Допустимые значения:
\begin{itemize}
\item \textbf{none} --- отсутствует;
\item \textbf{shared} --- классификатор ссылается на объект;
\item \textbf{composite} --- классификатор владеет объектом;
\end{itemize}

\textbf{Direction} --- тип параметра метода.

Допустимые значения:
\begin{itemize}
\item \textbf{in} --- метод только читает значение параметра и может изменять его состояние;
\item \textbf{out} --- метод только изменяет значение параметра;
\item \textbf{inout} --- метод читает и изменяет значение параметра;
\end{itemize}

\textbf{Visibility} --- доступность свойства или метода, допустимые значения.

Атрибуты:
\begin{itemize}
\item \textbf{private} --- только из этого же классификатора;
\item \textbf{protected} --- из этого класса и всех производных классификаторов;
\item \textbf{public} --- из любого места;
\end{itemize}

\textbf{Classifier} --- классификатор.

Атрибуты:
\begin{itemize}
\item \textbf{name} --- имя, уникальное для модели;
\item \textbf{poperty} --- свойства классификатора;
\item \textbf{operation} --- операции классификатора;
\item \textbf{general} --- базовые классификаторы;
\item \textbf{suppliers} --- используемые классификаторы;
\end{itemize}

\textbf{Property} --- свойство классификатора.

Атрибуты:
\begin{itemize}
\item \textbf{name} --- имя, уникальное для классификатора;
\item \textbf{owner} --- класс, которому принадлежит свойство;
\item \textbf{type} --- тип свойства;
\item \textbf{visibility} --- доступность;
\item \textbf{is\_static} --- имеет ли свойство одно значение для всех объектов классификатора;
\end{itemize}

\textbf{Operation} --- операция классификатора.
Атрибуты:
\begin{itemize}
\item \textbf{name} --- имя, уникальное для классификатора, типа результата и списка типов параметров;
\item \textbf{owner} --- классификатора, которому принадлежит операция;
\item \textbf{invoke} --- вызываемые операции;
\item \textbf{result} --- тип результата;
\item \textbf{parameter} --- список параметров;
\item \textbf{visibility} --- доступность;
\item \textbf{is\_static} --- запрещено ли методу оперировать состоянием объекта;
\end{itemize}

\textbf{Parameter} --- параметр метода класса.

Атрибуты:
\begin{itemize}
\item \textbf{name} --- имя, уникальное для операции;
\item \textbf{type} --- тип значения;
\item \textbf{direction} --- тип параметра;
\item \textbf{position} --- порядковый номер;
\end{itemize}

\textbf{Type} --- любой тип данных.

Атрибуты:
\begin{itemize}
\item \textbf{classifier} --- классификатор типа;
\item \textbf{lower} --- нижняя граница множественности $\left [ 0, upper \right ]$;
\item \textbf{upper} --- верхняя граница множественности $\left [ lower, \infty \right ]$;
\item \textbf{is\_unique} --- должны ли значения быть уникальными, если есть множественность;
\item \textbf{is\_ordered} --- упорядочены ли значения, если есть множественность.
\end{itemize}

\textbf{Class} --- класс.

\textbf{Interface} --- интерфейс.

\textbf{Enumeration} --- перечисление.

\textbf{DataType} --- абстрактный тип данных, используется для внешних зависимостей.

\textbf{PrimitiveType} --- примитивный тип данных, например \textbf{int} в \textbf{Java}.

\textbf{Model} --- модель объектно-ориентированной системы.

\textbf{MatchResult} --- результат поиска шаблонов проектирования.

\textbf{MatchVariant} --- вариант соответствия элементов цели элементам шаблона.

Атрибуты:
\begin{itemize}
\item \textbf{isomorphic} --- кортеж (\textbf{tuple}) пар объектов типа \textbf{Element}.
\end{itemize}

Реализация алгоритма поиска шаблонов проектирования --- функция \textbf{match}:

\begin{minted}{python}
def match(target, pattern, limit=None, all_components=False)
\end{minted}

Параметры:
\begin{itemize}
\item \textbf{target} --- целевая модель, объект типа \textbf{Model};
\item \textbf{pattern} --- модель шаблона, объект типа \textbf{Model};
\item \textbf{limit} --- \textbf{int}, максимальное количество
вариантов, которое нужно найти. Если \textbf{None}, то выполняется поиск всех;
\item \textbf{all\_components} --- выполнять ли поиск во всех компонентах графа
модели.
\end{itemize}

\section{Тестирование}

\subsection{Модульное тестирование}

\subsubsection{Тестирование модуля graph\_matcher}

Выделены следующие классы прецедентов:
\begin{enumerate}
    \item тестирование создания объектов и проверка их состояния:
    \begin{enumerate}
        \item класс \textbf{Node};
        \item класс \textbf{Configuration};
        \item класс \textbf{Equivalent};
        \item класс \textbf{Graph};
    \end{enumerate}
    \item тестирование реализации алгоритмов:
    \begin{enumerate}
        \item \textbf{Node.get\_connected\_component} --- компонента связности вершины;
        \item \textbf{Graph.get\_connected\_components} --- все компоненты связности графа;
        \item \textbf{match} --- поиск изоморфного подграфа.
    \end{enumerate}
\end{enumerate}

%\begin{enumerate}
%\item тестирование создания объектов и их методов:
%\begin{enumerate}
%    \item класс \textbf{Node};
%    \begin{enumerate}
%        \item отдельная вершина;
%    \end{enumerate}
%    \item класс \textbf{Configuration};
%    \begin{enumerate}
%        \item начальная конфигурация;
%    \end{enumerate}
%    \item класс \textbf{Equivalent};
%    \begin{enumerate}
%        \item между двумя объектами;
%    \end{enumerate}
%    \item класс \textbf{Graph};
%    \begin{enumerate}
%        \item пустой граф;
%        \item с одной вершиной;
%        \item с одной дугой, соединяющей две вершины;
%        \item с одной помеченной дугой;
%        \item с одной дугой, соединяюшей одну вершину;
%        \item с тремя вершинами и одной дугой, соединяющей две;
%        \item с тремя вершинами и одной помеченной дугой, соединяющей две;
%        \item с двумя вершинами, одной дугой, их соединяющей и повторением вершины;
%        \item с несколькими размеченными и нет дугами;
%    \end{enumerate}
%\end{enumerate}
%\item тестирование реализации алгоритмов:
%\begin{enumerate}
%    \item компонента связности вершины;
%    \begin{enumerate}
%        \item отдельная вершина;
%        \item две не соединенные вершины;
%        \item две соединенные одной дугой вершины;
%        \item две соединенные двумя дугами вершины;
%        \item три вершины, соединенные цепочкой;
%        \item четыре вершины, одна дуга соединяет одну пару, другая --- другую;
%    \end{enumerate}
%    \item все компоненты связности графа;
%    \begin{enumerate}
%        \item пустой граф;
%        \item с двумя вершинами;
%        \item с двумя вершинами, соединенными дугой;
%        \item ;
%        \item три вершины, соединенные цепочкой;
%        \item четыре вершины, одна дуга соединяет одну пару, другая --- другую;
%    \end{enumerate}
%    \item алгоритм поиска изоморфного подграфа;
%\end{enumerate}
%\item тестирование реализации алгоритмов:
%\end{enumerate}

\subsubsection{Тестирование модуля pattern\_matcher}

Выделены следующие классы прецедентов:
\begin{enumerate}
    \item тестирование создания объектов и проверка их состояния:
    \begin{enumerate}
        \item класс \textbf{Aggregation};
        \item класс \textbf{Class};
        \item класс \textbf{Classifier};
        \item класс \textbf{DataType};
        \item класс \textbf{Direction};
        \item класс \textbf{Enumeration};
        \item класс \textbf{Interface};
        \item класс \textbf{Model};
        \item класс \textbf{MatchVariant};
        \item класс \textbf{MatchResult};
        \item класс \textbf{Operation};
        \item класс \textbf{Parameter};
        \item класс \textbf{PrimitiveType};
        \item класс \textbf{Property};
        \item класс \textbf{Type};
        \item класс \textbf{Visibility};
    \end{enumerate}
    \item тестирование реализации алгоритмов:
    \begin{enumerate}
        \item \textbf{eq\_ignore\_order} --- сравнение коллекций без учета порядка;
        \item \textbf{match} --- поиск шаблона в модели;
        \item \textbf{check} --- проверка результата \textbf{match};
        \item чтение и запись модели в формате \textbf{YAML}.
    \end{enumerate}
\end{enumerate}

\subsubsection{Тестирование модуля java\_source\_parser}

\subsection{Функциональное тестирование}

\subsubsection{Тестирование программы java\_bytecode\_model}

\subsubsection{Тестирование программы match\_pattern}
